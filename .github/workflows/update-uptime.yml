name: Update Dashboard Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Fetch GitHub Stats and Update SVGs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: aaronestradabonilla777
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import re
          import os
          from datetime import datetime, timezone, timedelta
          from collections import defaultdict

          USERNAME = os.environ.get('USERNAME', 'aaronestradabonilla777')
          TOKEN = os.environ.get('GITHUB_TOKEN', '')

          headers = {
              'Authorization': f'token {TOKEN}',
              'Accept': 'application/vnd.github.v3+json'
          }

          print(f"üîÑ Fetching data for {USERNAME}...")

          # === FETCH USER PROFILE ===
          user_resp = requests.get(f'https://api.github.com/users/{USERNAME}', headers=headers)
          user_data = user_resp.json() if user_resp.status_code == 200 else {}

          public_repos = user_data.get('public_repos', 0)
          followers = user_data.get('followers', 0)
          following = user_data.get('following', 0)
          created_at = user_data.get('created_at', '2022-04-25T00:00:00Z')

          print(f"üìä Profile: {public_repos} repos, {followers} followers, {following} following")

          # === FETCH ALL REPOS FOR STARS AND LANGUAGES ===
          repos_resp = requests.get(
              f'https://api.github.com/users/{USERNAME}/repos?per_page=100&type=owner',
              headers=headers
          )
          repos = repos_resp.json() if repos_resp.status_code == 200 else []

          total_stars = sum(repo.get('stargazers_count', 0) for repo in repos if isinstance(repo, dict))
          print(f"‚≠ê Total stars: {total_stars}")

          # === CALCULATE LANGUAGE DISTRIBUTION ===
          lang_bytes = defaultdict(int)
          for repo in repos:
              if isinstance(repo, dict) and not repo.get('fork', False):
                  lang_url = repo.get('languages_url', '')
                  if lang_url:
                      lang_resp = requests.get(lang_url, headers=headers)
                      if lang_resp.status_code == 200:
                          for lang, bytes_count in lang_resp.json().items():
                              lang_bytes[lang] += bytes_count

          # Calculate percentages
          total_bytes = sum(lang_bytes.values())
          lang_percentages = {}
          if total_bytes > 0:
              for lang, bytes_count in sorted(lang_bytes.items(), key=lambda x: x[1], reverse=True)[:5]:
                  percentage = round((bytes_count / total_bytes) * 100)
                  lang_percentages[lang] = percentage

          print(f"üíª Languages: {lang_percentages}")

          # === CALCULATE UPTIME ===
          try:
              start_date = datetime.fromisoformat(created_at.replace('Z', '+00:00'))
          except:
              start_date = datetime(2022, 4, 25, tzinfo=timezone.utc)
          
          now = datetime.now(timezone.utc)
          diff = now - start_date
          total_seconds = int(diff.total_seconds())
          
          years = total_seconds // 31536000
          remaining = total_seconds % 31536000
          days = remaining // 86400
          remaining = remaining % 86400
          hours = remaining // 3600
          minutes = (remaining % 3600) // 60

          print(f"‚è±Ô∏è Uptime: {years}Y {days}D {hours}H {minutes}M")

          # === FETCH COMMIT HISTORY FOR 2026 ===
          print("üìù Fetching commit history...")
          
          # Get events for commit activity
          events_resp = requests.get(
              f'https://api.github.com/users/{USERNAME}/events?per_page=100',
              headers=headers
          )
          events = events_resp.json() if events_resp.status_code == 200 else []

          # Count commits per week (last 25 weeks for heatmap)
          commit_data = defaultdict(lambda: defaultdict(int))  # week -> day -> count
          
          for event in events:
              if isinstance(event, dict) and event.get('type') == 'PushEvent':
                  event_date_str = event.get('created_at', '')[:10]
                  try:
                      event_date = datetime.strptime(event_date_str, '%Y-%m-%d')
                      week_num = (now.date() - event_date.date()).days // 7
                      if week_num < 25:  # Last 25 weeks
                          day_of_week = event_date.weekday()
                          commits_in_push = len(event.get('payload', {}).get('commits', []))
                          commit_data[week_num][day_of_week] += commits_in_push
                  except:
                      pass

          total_commits = sum(sum(days.values()) for days in commit_data.values())
          print(f"üìä Total recent commits: {total_commits}")

          # Generate heatmap SVG
          def get_color(count):
              if count == 0:
                  return '#0e4429'
              elif count <= 2:
                  return '#006d32'
              elif count <= 5:
                  return '#26a641'
              else:
                  return '#39d353'

          heatmap_svg = []
          # Generate 25 weeks x 7 days heatmap
          for week in range(25):
              x = 20 + (week * 10)
              for day in range(7):
                  y = 25 + (day * 10)
                  count = commit_data.get(24 - week, {}).get(day, 0)
                  color = get_color(count)
                  heatmap_svg.append(f'      <rect x="{x}" y="{y}" width="8" height="8" fill="{color}" rx="1"/>')

          heatmap_block = '\n'.join(heatmap_svg)

          # === UPDATE header_v3.svg ===
          print("üìù Updating header_v3.svg...")
          
          with open('header_v3.svg', 'r', encoding='utf-8') as f:
              header_content = f.read()

          # Update profile stats
          header_content = re.sub(r'(PUBLIC_REPOS.*?font-size="28">)\d+(<\/text>)', 
                                  rf'\g<1>{public_repos}\2', header_content, flags=re.DOTALL)
          header_content = re.sub(r'(FOLLOWERS.*?font-size="28">)\d+(<\/text>)', 
                                  rf'\g<1>{followers}\2', header_content, flags=re.DOTALL)
          header_content = re.sub(r'(FOLLOWING.*?font-size="28">)\d+(<\/text>)', 
                                  rf'\g<1>{following}\2', header_content, flags=re.DOTALL)
          header_content = re.sub(r'(TOTAL_STARS.*?font-size="28">)\d+(<\/text>)', 
                                  rf'\g<1>{total_stars}\2', header_content, flags=re.DOTALL)

          # Update uptime
          header_content = re.sub(r'>(\d+)Y</text>', f'>{years}Y</text>', header_content)
          header_content = re.sub(r'>(\d+)D</text>', f'>{days}D</text>', header_content)
          header_content = re.sub(r'>(\d+)H</text>', f'>{hours}H</text>', header_content)
          header_content = re.sub(r'anim-blink" font-size="14">(\d+)</text>', 
                                  f'anim-blink" font-size="14">{minutes}</text>', header_content)

          with open('header_v3.svg', 'w', encoding='utf-8') as f:
              f.write(header_content)

          # === UPDATE core_v3.svg WITH LANGUAGES AND COMMIT HISTORY ===
          print("üìù Updating core_v3.svg...")
          
          try:
              with open('core_v3.svg', 'r', encoding='utf-8') as f:
                  core_content = f.read()

              # Update language percentages
              for lang, pct in lang_percentages.items():
                  pattern = rf'({lang}\s*)\d+%'
                  core_content = re.sub(pattern, rf'\g<1>{pct}%', core_content)

              # Update commit heatmap - replace the existing heatmap section
              # Find and replace the heatmap rectangles
              heatmap_pattern = r'(<g transform="translate\(20, 25\)">.*?)(<!-- More rows -->.*?</g>)'
              
              new_heatmap = f'''<g transform="translate(8, 25)">
      <!-- Generated commit heatmap for 2026 -->
{heatmap_block}
    </g>
    
    <g transform="translate(100, 98)">'''

              # Simple replacement of the heatmap area
              # Find the section between "translate(20, 25)" and the legend
              old_heatmap_start = core_content.find('<g transform="translate(20, 25)">')
              old_heatmap_end = core_content.find('<g transform="translate(100, 98)">')
              
              if old_heatmap_start != -1 and old_heatmap_end != -1:
                  core_content = (
                      core_content[:old_heatmap_start] + 
                      new_heatmap +
                      core_content[old_heatmap_end + len('<g transform="translate(100, 98)">'):]
                  )

              # Update version to v3.2
              core_content = re.sub(r'HALUZ_CORE_v[\d.]+', 'HALUZ_CORE_v3.2', core_content)

              with open('core_v3.svg', 'w', encoding='utf-8') as f:
                  f.write(core_content)
                  
          except Exception as e:
              print(f"‚ö†Ô∏è Error updating core_v3.svg: {e}")

          print("‚úÖ All SVGs updated successfully!")
          print(f"üìä Summary: {public_repos} repos, {followers} followers, {total_stars} stars, {total_commits} commits")

          PYTHON_SCRIPT
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add header_v3.svg core_v3.svg
          git diff --staged --quiet || git commit -m "chore: update dashboard stats [skip ci]"
          git push
