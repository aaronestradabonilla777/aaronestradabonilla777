name: Update Uptime

on:
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  update-uptime:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Update uptime in SVG
        run: |
          # Start date: April 25, 2022
          START_DATE="2022-04-25"
          
          # Calculate difference
          START_SECONDS=$(date -d "$START_DATE" +%s)
          NOW_SECONDS=$(date +%s)
          DIFF_SECONDS=$((NOW_SECONDS - START_SECONDS))
          
          # Calculate years, days, hours
          YEARS=$((DIFF_SECONDS / 31536000))
          REMAINING=$((DIFF_SECONDS % 31536000))
          DAYS=$((REMAINING / 86400))
          REMAINING=$((REMAINING % 86400))
          HOURS=$((REMAINING / 3600))
          REMAINING=$((REMAINING % 3600))
          MINUTES=$((REMAINING / 60))
          
          echo "Uptime: ${YEARS}Y ${DAYS}D ${HOURS}H ${MINUTES}M"
          
          # Update header_v3.svg with new values
          sed -i "s/>${YEARS}Y<\/text>$/<text x=\"17\" y=\"20\" text-anchor=\"middle\" class=\"f-mono c-cyan number-flux\" font-size=\"14\">${YEARS}Y<\/text>/g" header_v3.svg || true
          sed -i "s/>[0-9]*Y<\/text>/<text>${YEARS}Y<\/text>/g" header_v3.svg 2>/dev/null || true
          
          # More precise replacements using perl for complex patterns
          perl -i -pe "s/(\d+)Y(?=<\/text>)/${YEARS}Y/g" header_v3.svg
          perl -i -pe "s/(\d+)D(?=<\/text>)/${DAYS}D/g" header_v3.svg  
          perl -i -pe "s/>(\d+)H</>$HOURS H</g" header_v3.svg 2>/dev/null || true
          
          # Direct replacement approach
          python3 << EOF
          import re
          from datetime import datetime
          
          start_date = datetime(2022, 4, 25)
          now = datetime.utcnow()
          diff = now - start_date
          
          total_seconds = int(diff.total_seconds())
          years = total_seconds // 31536000
          remaining = total_seconds % 31536000
          days = remaining // 86400
          remaining = remaining % 86400
          hours = remaining // 3600
          minutes = (remaining % 3600) // 60
          
          with open('header_v3.svg', 'r') as f:
              content = f.read()
          
          # Replace uptime values
          content = re.sub(r'>(\d+)Y</text>', f'>{years}Y</text>', content)
          content = re.sub(r'>(\d+)D</text>', f'>{days}D</text>', content)
          content = re.sub(r'>(\d+)H</text>', f'>{hours}H</text>', content)
          content = re.sub(r'anim-blink" font-size="14">(\d+)</text>', f'anim-blink" font-size="14">{minutes}</text>', content)
          
          with open('header_v3.svg', 'w') as f:
              f.write(content)
          
          print(f"Updated uptime: {years}Y {days}D {hours}H {minutes}M")
          EOF
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add header_v3.svg
          git diff --staged --quiet || git commit -m "chore: update uptime counter [skip ci]"
          git push
